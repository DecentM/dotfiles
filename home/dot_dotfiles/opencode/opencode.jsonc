{
  "$schema": "https://opencode.ai/config.json",
  "share": "manual",
  "permission": {
    "*": "deny",
    "bash": {
      "python*": "deny", // use sandbox MCP
      "node*": "deny", // use sandbox MCP

      // Infra
      "kubectl patch*": "deny",
      "kubectl apply*": "deny",
      "flux*": "deny",

      "kubectl describe*": "allow",
      "kubectl get*": "allow",
      "kubectl logs*": "allow",
      "kubectl run*": "allow",
      "kubectl exec*": "allow",
      "kubectl wait*": "allow",
      "kubectl create job*": "allow",
      "kubectl delete job*": "allow",
      "kubectl version*": "allow",
      "kubectl version": "allow",

      "helm list*": "allow",
      "helm status*": "allow",
      "terraform plan*": "deny",
      "terraform show*": "allow",
      "terraform validate*": "allow",
      "terraform fmt*": "allow",
      "terraform version*": "allow",
      "terraform output*": "allow",
      "terraform state list*": "allow",
      "terraform state show*": "allow",
      "terraform providers*": "allow",
      "terraform graph*": "allow",
      // End infra

      // Shell utils
      "chmod*": "deny",
      "timeout*": "deny",
      "*.sh": "ask",
      "bin/*": "ask",
      "./*": "ask",
      "true": "allow",
      "false": "allow",

      "grep*": "allow",
      "sed*": "allow",
      "uniq": "allow",
      "tail*": "allow",
      "tail": "allow",
      "head*": "allow",
      "head": "allow",
      "sort*": "allow",
      "sort": "allow",
      "awk*": "allow",
      "cut*": "allow",
      "wc*": "allow",
      "wc": "allow",
      "ping*": "allow",
      "curl*": "allow",
      "echo*": "allow",
      "echo": "allow",
      "printf*": "allow",
      "printf": "allow",
      "ls*": "allow",
      "ls": "allow",
      "paste*": "allow",
      "column*": "allow",
      "xargs*": "allow",
      "find*": "allow",
      "cat*": "allow",
      "rg*": "allow",
      "basename*": "allow",
      "tree*": "allow",
      "wget*": "allow",
      "jq*": "allow",
      "jq": "allow",
      "yq*": "allow",
      "yq": "allow",
      "uniq*": "allow",
      "pwd": "allow",
      "which*": "allow",
      "sleep*": "allow",
      "mkdir*": "allow",
      // End shell utils

      // Package management
      // Fallback deny for all package managers - specific commands allowed below
      "yarn*": "deny",
      "pnpm*": "deny",
      "bun*": "deny",
      "cargo*": "deny",
      "npm*": "deny",
      "npx*": "deny",

      // npm - read-only and safe commands
      "npm info*": "allow",
      "npm run*": "allow",
      "npm audit*": "allow",
      "npm search*": "allow",
      "npm view*": "allow",
      "npm list*": "allow",
      "npm ls*": "allow",
      "npm outdated*": "allow",
      "npm explain*": "allow",
      "npm why*": "allow",
      "npm fund*": "allow",
      "npm doctor*": "allow",
      "npm prefix*": "allow",
      "npm root*": "allow",
      "npm bin*": "allow",
      "npm config list*": "allow",
      "npm config get*": "allow",
      "npm pack*": "allow",
      "npm version": "allow",
      "npm help*": "allow",
      "npm exec*": "allow",
      "npm test*": "allow",
      "npm start*": "allow",
      "npm rebuild*": "allow",
      "npm dedupe*": "allow",
      "npm prune*": "allow",

      // yarn - read-only and safe commands
      "yarn audit*": "allow",
      "yarn info*": "allow",
      "yarn list*": "allow",
      "yarn why*": "allow",
      "yarn outdated*": "allow",
      "yarn config list*": "allow",
      "yarn config get*": "allow",
      "yarn version": "allow",
      "yarn versions": "allow",
      "yarn cache list*": "allow",
      "yarn workspaces list*": "allow",
      "yarn licenses list*": "allow",
      "yarn run*": "allow",
      "yarn build*": "allow",
      "yarn test*": "allow",
      "yarn lint*": "allow",
      "yarn start*": "allow",
      "yarn dedupe*": "allow",
      "yarn explain*": "allow",
      "yarn pack*": "allow",
      "yarn help*": "allow",

      // pnpm - read-only and safe commands
      "pnpm audit*": "allow",
      "pnpm list*": "allow",
      "pnpm ls*": "allow",
      "pnpm outdated*": "allow",
      "pnpm why*": "allow",
      "pnpm licenses list*": "allow",
      "pnpm run*": "allow",
      "pnpm exec*": "allow",
      "pnpm env list*": "allow",
      "pnpm root*": "allow",
      "pnpm bin*": "allow",
      "pnpm prefix*": "allow",
      "pnpm store status*": "allow",
      "pnpm config list*": "allow",
      "pnpm config get*": "allow",
      "pnpm build": "allow",
      "pnpm test": "allow",
      "pnpm start": "allow",
      "pnpm moon": "allow",
      "pnpm dedupe*": "allow",
      "pnpm rebuild*": "allow",
      "pnpm prune*": "allow",
      "pnpm pack*": "allow",
      "pnpm help*": "allow",

      // bun - read-only and safe commands
      "bun run*": "allow",
      "bun test*": "allow",
      "bun build*": "allow",
      "bun x*": "deny", // like npx, can execute anything
      "bun pm ls*": "allow",
      "bun pm cache*": "allow",
      "bun outdated*": "allow",
      "bun --version": "allow",
      "bun --help": "allow",

      // cargo - read-only and safe commands
      "cargo check*": "allow",
      "cargo build*": "allow",
      "cargo test*": "allow",
      "cargo run*": "allow",
      "cargo doc*": "allow",
      "cargo bench*": "allow",
      "cargo tree*": "allow",
      "cargo metadata*": "allow",
      "cargo search*": "allow",
      "cargo info*": "allow",
      "cargo fetch*": "allow",
      "cargo verify-project*": "allow",
      "cargo locate-project*": "allow",
      "cargo read-manifest*": "allow",
      "cargo pkgid*": "allow",
      "cargo generate-lockfile*": "allow",
      "cargo clippy*": "allow",
      "cargo fmt*": "allow",
      "cargo audit*": "allow",
      "cargo fix*": "allow",
      "cargo clean*": "allow",
      "cargo vendor*": "allow",
      "cargo version*": "allow",
      "cargo --version": "allow",
      "cargo help*": "allow",
      // End package management

      // Build and test
      "tsc*": "allow",
      "eslint*": "allow",
      "prettier*": "allow",
      "jest*": "allow",
      "vitest*": "allow",
      "pytest*": "allow",
      "time*": "allow",
      "hyperfine*": "allow",
      "perf*": "allow",
      // End build and test

      // Containers
      // Fallback deny for docker commands - specific commands allowed below
      "docker*": "deny",
      "docker-compose*": "deny",

      // docker - read-only and safe commands
      "docker build*": "allow",
      "docker manifest inspect*": "allow",
      "docker search*": "allow",
      "docker pull*": "allow",
      "docker logs*": "allow",
      "docker images*": "allow",
      "docker run*": "allow",
      "docker ps*": "allow",
      "docker inspect*": "allow",
      "docker info*": "allow",
      "docker info": "allow",
      "docker version*": "allow",
      "docker version": "allow",
      "docker stats*": "allow",
      "docker top*": "allow",
      "docker port*": "allow",
      "docker diff*": "allow",
      "docker history*": "allow",
      "docker events*": "allow",
      "docker cp*": "allow",
      "docker tag*": "allow",
      "docker network ls*": "allow",
      "docker network inspect*": "allow",
      "docker volume ls*": "allow",
      "docker volume inspect*": "allow",
      "docker system df*": "allow",
      "docker system info*": "allow",
      "docker container ls*": "allow",
      "docker container logs*": "allow",
      "docker container inspect*": "allow",
      "docker image ls*": "allow",
      "docker image inspect*": "allow",
      "docker image history*": "allow",
      "docker buildx*": "allow",
      "docker context*": "allow",
      "docker help*": "allow",
      "docker --version": "allow",
      "docker --help": "allow",

      // docker compose - read-only and safe commands
      "docker compose ps*": "allow",
      "docker compose logs*": "allow",
      "docker compose config*": "allow",
      "docker compose top*": "allow",
      "docker compose images*": "allow",
      "docker compose port*": "allow",
      "docker compose version*": "allow",
      "docker compose ls*": "allow",
      "docker compose --help": "allow",
      "docker-compose ps*": "allow",
      "docker-compose logs*": "allow",
      "docker-compose config*": "allow",
      "docker-compose top*": "allow",
      "docker-compose images*": "allow",
      "docker-compose port*": "allow",
      "docker-compose version*": "allow",
      "docker-compose --help": "allow",

      // distrobox - read-only commands only
      "distrobox*": "deny",
      "distrobox list*": "allow",
      "distrobox ls*": "allow",
      "distrobox version*": "allow",
      "distrobox --help": "allow",
      "distrobox-export --list-apps*": "allow",
      "distrobox-export --list-binaries*": "allow",
      "distrobox-export --help": "allow",
      "distrobox-export --version": "allow"
      // End containers
    },
    "edit": {
      "*": "allow",
      ".key": "deny",
      ".env": "deny",
      ".env.*": "deny",
      ".env.example": "allow",
    },
    "glob": {
      "*": "allow",
    },
    "webfetch": "allow",
    "websearch": "allow",
    "grep": "allow",
    "list": "allow",
    "lsp": "allow",
    "task": "allow",
    "todoread": "allow",
    "todowrite": "allow",
    "question": "allow",
    "read": {
      "*": "allow",
      ".env": "deny",
      ".env.*": "deny",
      ".env.example": "allow",
    },
    "codesearch": "allow",
    "skill": "allow",

    // MCPs
    "sequentialthinking_*": "allow",
    "memory_*": "allow",
    "time_*": "allow",

    // Sandbox MCPs - delegate to specialized agents
    "sandbox-node-deno_*": "deny",
    "sandbox-python_*": "deny",
    "flaresolverr_*": "deny",
  },
  "instructions": [
    "~/.dotfiles/opencode/rules/base.md",
    "AGENTS.md",
    ".cursorrules",
    ".cursor/rules/*.{md,mdx}",
  ],
  "mcp": {
    "sequentialthinking": {
      "type": "local",
      "command": [
        "docker",
        "run",
        "--rm",
        "-i",
        "--network=none",
        "--memory=512m",
        "--cpus=1",
        "mcp/sequentialthinking",
      ],
      "enabled": true,
    },
    "time": {
      "type": "local",
      "command": [
        "docker",
        "run",
        "--rm",
        "-i",
        "--network=none",
        "--memory=512m",
        "--cpus=1",
        "mcp/time",
      ],
      "enabled": true,
    },

    // Sandbox MCP servers for safe code execution (builds inline on first run)
    "sandbox-node-deno": {
      "type": "local",
      "command": [
        "bash",
        "-c",
        "docker run --rm -i --init --network=none --memory=512m --cpus=1 $(docker build -q -f ~/.dotfiles/opencode/docker/repl-mcp.dockerfile ~/.dotfiles/opencode/docker)",
      ],
      "enabled": true,
    },
    "sandbox-python": {
      "type": "local",
      "command": [
        "bash",
        "-c",
        "docker run --rm -i --init --network=none --memory=512m --cpus=1 $(docker build -q -f ~/.dotfiles/opencode/docker/mcp-python.dockerfile ~/.dotfiles/opencode/docker)",
      ],
      "enabled": true,
    },
    "flaresolverr": {
      "type": "local",
      "command": [
        "bash",
        "-c",
        // Bundled container: Flaresolverr + Chromium + MCP server (~900MB, needs more resources)
        "docker run --rm -i --init --shm-size=2g --memory=2g --cpus=2 $(docker build -q -f ~/.dotfiles/opencode/docker/mcp-flaresolverr.dockerfile ~/.dotfiles/opencode/docker)",
      ],
      "enabled": true,
    },
  },
}
